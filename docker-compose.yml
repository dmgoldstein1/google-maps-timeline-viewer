# Generated by GitHub Copilot (GPT-5)
# Docker Compose configuration for Google Maps Timeline Viewer
# This file defines the services, volumes, and secrets for the application

version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
        - linux/arm64
    image: google-maps-timeline-viewer:latest
    container_name: timeline-viewer
    restart: unless-stopped
    
    ports:
      - "8080:8080"
    
    volumes:
      # Persistent data storage (database, photos, logs)
      - timeline-data:/data
      # Timeline JSON files
      - timeline-files:/data/timeline
    
    secrets:
      - google_api_key
    
    environment:
      # API key configuration (uses Docker secret)
      GOOGLE_MAPS_API_KEY_FILE: /run/secrets/google_api_key
      
      # Cache configuration
      CACHE_TTL_DAYS: 180
      
      # API quota limits
      DAILY_API_QUOTA: 5000
      
      # Prefetch configuration
      MAX_CONCURRENT_FETCHES: 5
      API_REQUEST_DELAY_MS: 200
      
      # Photo sizes
      PHOTO_SIZES: "150,400,800,1200"
      
      # Image quality
      WEBP_QUALITY: 85
      JPEG_QUALITY: 80
      
      # Logging
      LOG_LEVEL: info
      
      # Server
      PORT: 3000
      NODE_ENV: production
    
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  # Persistent data volume for cache database, photos, and logs
  timeline-data:
    driver: local
  
  # Volume for timeline JSON files
  timeline-files:
    driver: local

secrets:
  # Google Maps API key loaded from file
  google_api_key:
    file: ./secrets/google_api_key.txt
