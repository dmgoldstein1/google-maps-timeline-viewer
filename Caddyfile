# Generated by GitHub Copilot (GPT-5)
# Caddyfile - Caddy web server configuration
# Serves static files and reverse proxies API requests to Node.js

:8080 {
	# Root directory for static files
	root * /app/public
	
	# Enable file server
	file_server
	
	# Reverse proxy API requests to Node.js server
	reverse_proxy /api/* localhost:3000 {
		# Disable buffering for Server-Sent Events
		flush_interval -1
	}
	
	# Enable compression
	encode gzip zstd
	
	# Cache control for static assets
	@static {
		path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.woff *.woff2
	}
	header @static Cache-Control "public, max-age=31536000"
	
	# Cache control for photos (1 month)
	@photos {
		path /api/photo/*
	}
	header @photos Cache-Control "public, max-age=2592000"
	
	# Security headers
	header {
		# Remove server header
		-Server
		
		# XSS protection
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		X-XSS-Protection "1; mode=block"
		
		# Referrer policy
		Referrer-Policy "strict-origin-when-cross-origin"
	}
	
	# Access logging
	log {
		output file /data/logs/access.log {
			roll_size 100mb
			roll_keep 5
			roll_keep_for 720h
		}
		format json
	}
	
	# Handle SPA routing - serve timeline.html for non-API routes
	@notapi {
		not path /api/*
		not path *.js
		not path *.css
		not path *.png
		not path *.jpg
		not path *.jpeg
		not path *.gif
		not path *.ico
		file {
			try_files {path} /timeline.html
		}
	}
	rewrite @notapi /timeline.html
}
